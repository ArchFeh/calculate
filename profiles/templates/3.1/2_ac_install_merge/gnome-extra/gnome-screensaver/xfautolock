# Calculate path=/usr/bin chmod=0755
#!/bin/bash

OFFTIME=0
# check work X server and xset command
while xset -q &>/dev/null
do
	# activate sleep timer
	xset -q | grep Monitor | grep -q On && TIMER=1
	# check is monitor off and DMPS enabled
	if xset -q | grep -q "DPMS is Enabled" && ! xset -q | grep Monitor | grep -q On
	then
		# lock session work only in active console
		if /usr/bin/ck-list-sessions | grep -A 5 "unix-user = '$(id -u)'" | grep -q "active = TRUE"
		then
			# wait 5 sec before lock session
			if [[ $OFFTIME -gt 5 ]]
			then
				t=$(date +%s)
				# if screensaver is not active and qdbus command work without hanging
				if [ "$(qdbus org.gnome.ScreenSaver / GetActive)" != "true" ] && [[ "$(( $(date +%s) - $t ))" -lt 5 ]]
				then
					# get "lock" param from user calculate.ini
					[[ "$(sed -nr '/\[main\]/{:s;n;s/lock\s*=\s*(\w+)/\1/p;/\[/b;bs}' $HOME/.calculate/ini.env)" == "on" ]] && /usr/bin/xflock4
				else
					# drop timer
					OFFTIME=0
				fi
			fi
			# increase timer
			[[ -n "$TIMER" ]] && OFFTIME=$(( $OFFTIME + 1 ))
		else
			# drop timer, turn off timer
			OFFTIME=0
			TIMER=
		fi
	else
		# drop timer
		OFFTIME=0
	fi
	sleep 1
done
