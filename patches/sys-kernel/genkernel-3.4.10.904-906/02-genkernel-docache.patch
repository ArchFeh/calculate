diff -ruN genkernel.orig/defaults/initrd.scripts genkernel/defaults/initrd.scripts
--- genkernel.orig/defaults/initrd.scripts	2009-08-07 16:16:45.000000000 +0400
+++ genkernel/defaults/initrd.scripts	2009-08-07 16:29:44.000000000 +0400
@@ -166,14 +166,23 @@
 		check_loop
 		if [ "${DO_cache}" ]
 		then
-			# TODO: Check the size of the image versus the size of our tmpfs
-			# along with the amount of available RAM and increase tmpfs size
-			# if necessary. (Not having awk sucks...)
-			# z=0
-			# for i in $(cat /proc/meminfo | grep -e ^MemFree -e ^Cached | \
-			# cut -d: -f2 | cut -dk -f1 | sed -e "s/^\s*//") ; do
-			# z=$(($z + $i)) ; done
-			# echo $z
+			# getting memory
+			z=0
+			for i in $(cat /proc/meminfo | grep -e ^MemFree -e ^Cached | \
+			cut -d: -f2 | cut -dk -f1 | sed -e "s/^\s*//") ; do
+			z=$(($z + $i)) ; done
+
+			# getting size tmpfs of default
+			let curtfs=$z/2
+
+			# getting size of image
+			let q=`ls -la ${NEW_ROOT}/mnt/cdrom/${LOOP} | sed -r -n 's/(\S*\s*){4}(\S*).*/\2/p'`/5000*6
+
+			if [[ $((${curtfs}<${q})) = "1" -a $((${q}<${z})) = "1" ]];
+			then
+				good_msg "Increasing size of tmpfs for ${NEW_ROOT}"
+				mount -o remount,size=${q}000 -t tmpfs tmpfs ${NEW_ROOT}
+			fi
 			good_msg "Copying loop file for caching..."
 			cp -a ${NEW_ROOT}/mnt/cdrom/${LOOP} ${NEW_ROOT}/mnt/${LOOP}
 			if [ $? -ne 0 ]
@@ -184,6 +193,8 @@
 				rm -rf ${NEW_ROOT}/mnt/zisofs 2>/dev/null
 			else
 				LOOPEXT='../'
+				good_msg "Unmounting media from ${NEW_ROOT}/mnt/cdrom"
+				umount ${NEW_ROOT}/mnt/cdrom
 			fi
 		fi
 	fi
